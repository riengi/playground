// @version=5
strategy(title="SqzMomentum", shorttitle="SQZM", overlay=true, margin_long=100, margin_short=100)

length = input.int(20, title="BB Length")
mult = input(2.0,title="BB MultFactor")
lengthKC=input(20, title="KC Length")
multKC = input(1.5, title="KC MultFactor")

useTrueRange = input(true, title="Use TrueRange (KC)")

// Calculate BB
source = close
basis = ta.sma(source, length)
dev = multKC * ta.stdev(source, length)
upperBB = basis + dev
lowerBB = basis - dev

// Calculate KC
ma = ta.hma(source, lengthKC)
range2 = useTrueRange ? ta.tr : (high - low)
rangema = ta.wma(range2, lengthKC)
upperKC = ma + rangema * multKC
lowerKC = ma - rangema * multKC

sqzOn  = (lowerBB > lowerKC) and (upperBB < upperKC)
sqzOff = (lowerBB < lowerKC) and (upperBB > upperKC)
noSqz  = (sqzOn == false) and (sqzOff == false)

val = ta.linreg(source  -   math.avg(math.avg(ta.highest(high, lengthKC), ta.lowest(low, lengthKC)),ta.rma(close,lengthKC)), lengthKC,0)

iff_1 = val > nz(val[1]) ? color.lime : color.green
iff_2 = val < nz(val[1]) ? color.red : color.maroon

bcolor =  val > 0 ? iff_1 : iff_2

scolor = noSqz ? color.blue : sqzOn ? color.black : color.gray 

plot(val, color=bcolor, style=plot.style_histogram, linewidth=4)
plot(0, color=scolor, style=plot.style_cross, linewidth=2)


// Stochastic
periodK = input.int(14, title="%K Length", minval=1)
smoothK = input.int(1, title="%K Smoothing", minval=1)
periodD = input.int(3, title="%D Smoothing", minval=1)
k = ta.sma(ta.stoch(close, high, low, periodK), smoothK)
d = ta.sma(k, periodD)

longCondition = val > val[1] and val < 0 and sqzOff==true and d > 50 and k > d
if (longCondition)
    strategy.entry("My Long Entry Id", strategy.long)


shortCondition = val < val[1] and val > 0 and sqzOff==true and d < 50 and k < d
if (shortCondition)
    strategy.entry("My Short Entry Id", strategy.short)


// longCondition = ta.crossover(ta.sma(close,14), ta.sma(close,28))
// if (longCondition)
//     strategy.entry("My Long Entry Id", strategy.long)

// shortCondition = ta.crossunder(ta.sma(close,14), ta.sma(close,28))
// if (shortCondition)
//     strategy.entry("My Long Entry Id", strategy.short)


// BB Length 20
// BB MultFactor 2
// KC Length 90
// KC MultFactor 5
